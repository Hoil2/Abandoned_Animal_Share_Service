<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.spring.ex.ShareCenterMapper">

	<!-- 분양센터 게시판 전체 최신순 출력 -->
	<select id="getShareCenterBoardPage" resultType="hashMap">
		SELECT aai.desertion_no, aai.happen_dt, aai.sex_cd , aai.popfile, aai.hit, aai.kind_cd,
		 (SELECT COUNT(*) FROM abandoned_animal_good aag WHERE aai.desertion_no = aag.desertion_no) good
		FROM abandoned_animal_info aai 
		<!-- WHERE process_state = '보호중'  -->
		<include refid="Search"></include> LIMIT #{Page}, #{PageSize};
	</select>
	
	<!-- 분양센터 게시글 총 갯수 -->
	<select id="getShareCenterBoardViewTotalCount" resultType="int">
		SELECT COUNT(*) FROM abandoned_animal_info <include refid="Search"></include> 
	</select>
	
	<!-- 공공데이터 유기동물 API DB에 저장 -->
	<insert id="setDbShareCenterApiResponse">
		INSERT INTO abandoned_animal_info(desertion_no, filename, happen_dt, happen_place, kind_cd, color_cd, age, weight, notice_no, notice_sdt, notice_edt, popfile, process_state, sex_cd, neuter_yn, special_mark, hit) 
		VALUES(
			#{desertion_no}, 
			#{filename}, 
			#{happen_dt}, 
			#{happen_place}, 
			#{kind_cd}, 
			#{color_cd}, 
			#{age}, 
			#{weight}, 
			#{notice_no}, 
			#{notice_sdt}, 
			#{notice_edt}, 
			#{popfile}, 
			#{process_state}, 
			#{sex_cd}, 
			#{neuter_yn}, 
			#{special_mark},
			0)
		ON DUPLICATE KEY UPDATE
			desertion_no=#{desertion_no},
			filename=#{filename}, 
			happen_dt=#{happen_dt}, 
			happen_place= #{happen_place}, 
			kind_cd=#{kind_cd}, 
			color_cd= #{color_cd}, 
			age=#{age}, 
			weight=#{weight}, 
			notice_no=#{notice_no}, 
			notice_sdt=#{notice_sdt}, 
			notice_edt=#{notice_edt}, 
			popfile=#{popfile}, 
			process_state=#{process_state}, 
			sex_cd=#{sex_cd}, 
			neuter_yn=#{neuter_yn}, 
			special_mark=#{special_mark}
	</insert>
	
	<!--WHERE kind_cd LIKE '[개]%' AND process_state = '보호중'  -->
	
	<sql id="Search">
		<choose>
			<!--전체, 전체, 정렬 -->
			<when test="searchTheme == 'allTheme' and searchArea == 'allArea' and searchAlignment == alignmentDay">
				ORDER BY happen_dt DESC
			</when>
			<when test="searchTheme == 'allTheme' and searchArea == 'allArea' and searchAlignment == alignmentHit">
				ORDER BY hit DESC
			</when>
			<when test="searchTheme == 'allTheme' and searchArea == 'allArea' and searchAlignment == alignmentGood">
				ORDER BY good DESC
			</when>
			<!--선택, 전체, 정렬 -->
			<when test="searchTheme == 'allTheme' and searchArea == 'allArea' and searchAlignment == alignmentDay">
				WHERE kind_cd LIKE CONCAT('%', #{searchTheme}, '%') ORDER BY happen_dt DESC
			</when>
			<when test="searchTheme == 'allTheme' and searchArea == 'allArea' and searchAlignment == alignmentDay">
				WHERE kind_cd LIKE CONCAT('%', #{searchTheme}, '%') ORDER BY ORDER BY hit DESC
			</when>
			<when test="searchTheme == 'allTheme' and searchArea == 'allArea' and searchAlignment == alignmentDay">
				WHERE kind_cd LIKE CONCAT('%', #{searchTheme}, '%') ORDER BY good DESC
			</when>
			<!--전체, 선택, 정렬 -->
			<when test="searchTheme == 'allTheme' and searchArea == 'allArea' and searchAlignment == alignmentDay">
				WHERE notice_no LIKE CONCAT('%', #{searchArea}, '%') ORDER BY happen_dt DESC
			</when>
			<when test="searchTheme == 'allTheme' and searchArea == 'allArea' and searchAlignment == alignmentHit">
				WHERE notice_no LIKE CONCAT('%', #{searchArea}, '%') ORDER BY ORDER BY hit DESC
			</when>
			<when test="searchTheme == 'allTheme' and searchArea == 'allArea' and searchAlignment == alignmentGood">
				WHERE notice_no LIKE CONCAT('%', #{searchArea}, '%') ORDER BY good DESC
			</when>
			<!--선택, 선택, 정렬 -->
			<when test="searchTheme == 'allTheme' and searchArea == 'allArea' and searchAlignment == alignmentDay">
				WHERE kind_cd LIKE CONCAT('%', #{searchTheme}, '%') AND notice_no LIKE CONCAT('%', #{searchArea}, '%') ORDER BY happen_dt DESC
			</when>
			<when test="searchTheme == 'allTheme' and searchArea == 'allArea' and searchAlignment == alignmentHit">
				WHERE kind_cd LIKE CONCAT('%', #{searchTheme}, '%') AND notice_no LIKE CONCAT('%', #{searchArea}, '%') ORDER BY ORDER BY hit DESC
			</when>
			<when test="searchTheme == 'allTheme' and searchArea == 'allArea' and searchAlignment == alignmentGood">
				WHERE kind_cd LIKE CONCAT('%', #{searchTheme}, '%') AND notice_no LIKE CONCAT('%', #{searchArea}, '%') ORDER BY good DESC
			</when>
		</choose>
	</sql>
</mapper>